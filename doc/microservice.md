# Microservice Documentation

This document outlines the structure and content of the API documentation for the microservices of this project in Version 2. It serves as a guide for developers to understand how to use the simplified API architecture effectively.

## Overview

1. **Warehouse**
    - Manages the storage and retrieval of data with simplified schema. 
    - Contains the following tables:
        1. *Trajectory Tables*: Simplified entries with cur_avgQ field.
        2. *Parameter Server*: Stores model parameters (not detailed here).

2. **Weapon Services (Job Executors)**
    - Run as independent containerized services to collect trajectories using different strategies.
    - **No public API endpoints** - these services execute trajectory collection jobs autonomously.
    - Services are deployed as standalone containers that continuously collect and store trajectory data.
    - Types of weapon services:
        - **Clusterbomb**: Collects trajectories using purely random exploration strategy. Runs continuously to build diverse trajectory datasets.
        - **Missile** (future implementation): Will collect trajectories using AI/RL models for guided exploration. Leverages learned policies for more targeted data collection.

## Database Schema

**V2 Schema Changes**: The V2 architecture eliminates linked list structures in trajectory data by embedding complete formula reconstruction information within each trajectory record.

Because MongoDB does not have a native UUID type, we use UUIDs as strings in the database.

### Trajectory Table (MongoDB)

**V2 Schema**: Each trajectory contains the COMPLETE formula construction sequence, combining both base formula reconstruction (prefix) and new exploration steps (suffix). This eliminates the linked list structure and enables direct formula reconstruction.

| Column Name      | Type     | Description                                      |
|------------------|:----------:|--------------------------------------------------|
| traj_id               | UUID     | Primary key                                      |
| timestamp        | datetime | The time when the trajectory was generated       |
| num_vars         | int   | Number of variables in the trajectory               |
| width            | int      | Width of the trajectory                             |
| steps            | list[list] | **V2**: Complete trajectory steps stored as lists `[token_type, token_literals, cur_avgQ]` |
| step[0]          | int      | The type of the token, 0 for ADD, 1 for DELETE    |
| step[1]          | int      | The binary representation for the literals of the token |
| step[2]          | float    | **V2**: Current average Q-value for this specific step |

**V2 Key Changes**:
- **Complete Trajectories**: No more partial/linked trajectories - each record contains full reconstruction sequence
- **Embedded Base Formulas**: Prefix trajectory steps embedded within each trajectory record
- **Direct Reconstruction**: Formula definitions reconstructed directly from trajectory steps without database lookups
- **Consistent avgQ**: All steps include `cur_avgQ` field for trajectory analysis
- **Optimized Storage**: Steps stored as lists `[token_type, token_literals, cur_avgQ]` for 45.9% BSON size reduction
- **Tuple API Format**: API returns steps as tuples `(token_type, token_literals, cur_avgQ)` for efficiency

## API Endpoints

### Warehouse

The Warehouse is a microservice that manages the storage and retrieval of trajectory data. It abstracts the complexity of data management and provides a simple interface for data access.

#### Data Format

When request is not passed in a correct format, the server will return a `422 Unprocessable Entity` error.

For every token literals in the request body, it should be represented as a 64-bits integer, the first 32 bits for the positive literals and the last 32 bits for the negative literals.

#### `GET /trajectory`
Retrieve a trajectory by its ID.

- **Query Parameters:**  
    - `traj_id` (string, required): Trajectory UUID.

- **Response:**  
    ```json
    {
        "traj_id": "t456",
        "steps": [
            [0, 5, 2.3]
        ],
        "timestamp": "2025-07-21T12:00:00Z"
    }
    ```
    Note: Steps are returned as tuples `[token_type, token_literals, cur_avgQ]` for reduced data redundancy.
- **Status Codes:**  
    - `200 OK`, `404 Not Found`

#### `POST /trajectory`
Add a new trajectory. The fields `traj_id` and `timestamp` are automatically generated by the server.

- **Request Body:**  
    ```json
    {
        "steps": [
            [0, 5, 2.3]
        ]
    }
    ```
    Note: Steps must be provided as tuples `[token_type, token_literals, cur_avgQ]`.
- **Response:**  
    ```json
    {
        "traj_id": "t456"
    }
    ```
- **Status Codes:**  
    - `201 Created`, `422 Unprocessable Entity`

#### `PUT /trajectory`
Update an existing trajectory.

- **Request Body:**  
    ```json
    {
        "traj_id": "t456",
        "steps": [
            [1, 3, 2.8]
        ]
    }
    ```
    Note: Steps must be provided as tuples `[token_type, token_literals, cur_avgQ]`.
- **Response:**  
    - Success message.
- **Status Codes:**  
    - `200 OK`, `422 Unprocessable Entity`, `404 Not Found`

#### `DELETE /trajectory`
Delete a trajectory.

- **Query Parameters:**  
    - `traj_id` (string, required): Trajectory UUID.

- **Response:**  
    - Success message.
- **Status Codes:**  
    - `200 OK`, `404 Not Found`

#### `DELETE /trajectory/purge`
**DESTRUCTIVE OPERATION**: Completely purge all trajectory data from MongoDB. This operation cannot be undone.

- **Request Body:** None
- **Response:**  
    ```json
    {
        "success": true,
        "deleted_count": 1247,
        "message": "Successfully purged 1247 trajectories from MongoDB",
        "timestamp": "2025-01-21T14:30:45.123456"
    }
    ```
- **Status Codes:**  
    - `200 OK`, `500 Internal Server Error`

#### `GET /trajectory/dataset`
Get the complete trajectory dataset with all trajectories using optimized tuple format for steps.

**TODO:** Add an index on the timestamp field in MongoDB for efficient range queries on trajectory timestamps.

- **Query Parameters:**
    - `num_vars` (int, optional): Filter trajectories by number of variables
    - `width` (int, optional): Filter trajectories by width
    - `since` (datetime, optional): Filter trajectories to only include those with timestamp after this date (ISO 8601 format)
    - `until` (datetime, optional): Filter trajectories to only include those with timestamp before this date (ISO 8601 format)

- **Response:**
    ```json
    {
        "trajectories": [
            {
                "traj_id": "t456",
                "timestamp": "2023-01-01T00:00:00Z",
                "num_vars": 3,
                "width": 2,
                "steps": [
                    [0, 5, 0.75],
                    [1, 3, 0.85]
                ]
            }
        ]
    }
    ```
    Note: Each step is represented as a tuple `[token_type, token_literals, cur_avgQ]` for reduced data redundancy.

- **Status Codes:**
    - `200 OK`: Successfully retrieved trajectories (may return empty list if no trajectories match filters or if `since` > `until`)
    - `400 Bad Request`: Invalid date format in `since` or `until` parameters or if `since` timestamp is after `until` timestamp

#### `GET /health`
Check the health status of the warehouse service.

- **Request:** No parameters required
- **Response:**
    ```json
    {
        "status": "healthy"
    }
    ```
- **Status Codes:**
    - `200 OK`: Service is healthy and ready to accept requests
    - `500 Internal Server Error`: Service is unhealthy (e.g., database connection failed)
- **Description:** 
    - This endpoint performs a basic health check on the warehouse service
    - Verifies MongoDB connectivity during service startup
    - Used for monitoring, load balancers, and container orchestration health checks
    - No authentication required
